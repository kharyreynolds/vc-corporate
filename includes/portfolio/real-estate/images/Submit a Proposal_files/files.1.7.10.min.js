!function(){function a(a,b){window.XMLHttpRequest.prototype[a]=b(window.XMLHttpRequest.prototype[a])}function b(a,b,c){try{Object.defineProperty(a,b,{get:c})}catch(d){}}var c=function(){try{var a=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");if(a)return!0}catch(b){if(void 0!=navigator.mimeTypes["application/x-shockwave-flash"])return!0}return!1};if(window.XMLHttpRequest&&!window.FormData||window.FileAPI&&FileAPI.forceLoad){var d=function(a){if(!a.__listeners){a.upload||(a.upload={}),a.__listeners=[];var b=a.upload.addEventListener;a.upload.addEventListener=function(c,d,e){a.__listeners[c]=d,b&&b.apply(this,arguments)}}};a("open",function(a){return function(b,c,e){d(this),this.__url=c;try{a.apply(this,[b,c,e])}catch(f){f.message.indexOf("Access is denied")>-1&&a.apply(this,[b,"_fix_for_ie_crossdomain__",e])}}}),a("getResponseHeader",function(a){return function(b){return this.__fileApiXHR&&this.__fileApiXHR.getResponseHeader?this.__fileApiXHR.getResponseHeader(b):null==a?null:a.apply(this,[b])}}),a("getAllResponseHeaders",function(a){return function(){return this.__fileApiXHR&&this.__fileApiXHR.getAllResponseHeaders?this.__fileApiXHR.getAllResponseHeaders():null==a?null:a.apply(this)}}),a("abort",function(a){return function(){return this.__fileApiXHR&&this.__fileApiXHR.abort?this.__fileApiXHR.abort():null==a?null:a.apply(this)}}),a("setRequestHeader",function(a){return function(b,c){if("__setXHR_"===b){d(this);var e=c(this);e instanceof Function&&e(this)}else this.__requestHeaders=this.__requestHeaders||{},this.__requestHeaders[b]=c,a.apply(this,arguments)}}),a("send",function(a){return function(){var d=this;if(arguments[0]&&arguments[0].__isFileAPIShim){var e=arguments[0],f={url:d.__url,jsonp:!1,cache:!0,complete:function(a,c){d.__completed=!0,!a&&d.__listeners.load&&d.__listeners.load({type:"load",loaded:d.__loaded,total:d.__total,target:d,lengthComputable:!0}),!a&&d.__listeners.loadend&&d.__listeners.loadend({type:"loadend",loaded:d.__loaded,total:d.__total,target:d,lengthComputable:!0}),"abort"===a&&d.__listeners.abort&&d.__listeners.abort({type:"abort",loaded:d.__loaded,total:d.__total,target:d,lengthComputable:!0}),void 0!==c.status&&b(d,"status",function(){return 0==c.status&&a&&"abort"!==a?500:c.status}),void 0!==c.statusText&&b(d,"statusText",function(){return c.statusText}),b(d,"readyState",function(){return 4}),void 0!==c.response&&b(d,"response",function(){return c.response});var e=c.responseText||(a&&0==c.status&&"abort"!==a?a:void 0);b(d,"responseText",function(){return e}),b(d,"response",function(){return e}),a&&b(d,"err",function(){return a}),d.__fileApiXHR=c,d.onreadystatechange&&d.onreadystatechange(),d.onload&&d.onload()},fileprogress:function(a){if(a.target=d,d.__listeners.progress&&d.__listeners.progress(a),d.__total=a.total,d.__loaded=a.loaded,a.total===a.loaded){var b=this;setTimeout(function(){d.__completed||(d.getAllResponseHeaders=function(){},b.complete(null,{status:204,statusText:"No Content"}))},1e4)}},headers:d.__requestHeaders};f.data={},f.files={};for(var g=0;g<e.data.length;g++){var h=e.data[g];null!=h.val&&null!=h.val.name&&null!=h.val.size&&null!=h.val.type?f.files[h.key]=h.val:f.data[h.key]=h.val}setTimeout(function(){if(!c())throw'Adode Flash Player need to be installed. To check ahead use "FileAPI.hasFlash"';d.__fileApiXHR=FileAPI.upload(f)},1)}else a.apply(d,arguments)}}),window.XMLHttpRequest.__isFileAPIShim=!0;var e=function(a){if(!c())throw'Adode Flash Player need to be installed. To check ahead use "FileAPI.hasFlash"';var b=angular.element(a);if(!(b.attr("disabled")||b.hasClass("js-fileapi-wrapper")||null==b.attr("ng-file-select")&&null==b.attr("data-ng-file-select")&&null==b.attr("ng-file-generated-elem--")||(b.addClass("js-fileapi-wrapper"),null==b.attr("ng-file-generated-elem--")))){var d=angular.element(document.getElementById("e"+b.attr("id")));d.bind("mouseover",function(){""!==b.parent().css("position")&&"static"!==b.parent().css("position")||b.parent().css("position","relative"),b.css("position","absolute").css("top",d[0].offsetTop+"px").css("left",d[0].offsetLeft+"px").css("width",d[0].offsetWidth+"px").css("height",d[0].offsetHeight+"px").css("padding",d.css("padding")).css("margin",d.css("margin")).css("filter","alpha(opacity=0)"),d.attr("onclick",""),b.css("z-index","1000")})}},f=function(a){return function(b){for(var c=FileAPI.getFiles(b),d=0;d<c.length;d++)void 0===c[d].size&&(c[d].size=0),void 0===c[d].name&&(c[d].name="file"),void 0===c[d].type&&(c[d].type="undefined");b.target||(b.target={}),b.target.files=c,b.target.files!=c&&(b.__files_=c),(b.__files_||b.target.files).item=function(a){return(b.__files_||b.target.files)[a]||null},a&&a.apply(this,[b])}},g=function(a,b){return("change"===b.toLowerCase()||"onchange"===b.toLowerCase())&&"file"==a.getAttribute("type")};HTMLInputElement.prototype.addEventListener&&(HTMLInputElement.prototype.addEventListener=function(a){return function(b,c,d,h){g(this,b)?(e(this),a.apply(this,[b,f(c),d,h])):a.apply(this,[b,c,d,h])}}(HTMLInputElement.prototype.addEventListener)),HTMLInputElement.prototype.attachEvent&&(HTMLInputElement.prototype.attachEvent=function(a){return function(b,c){g(this,b)?(e(this),window.jQuery?angular.element(this).bind("change",f(null)):a.apply(this,[b,f(c)])):a.apply(this,[b,c])}}(HTMLInputElement.prototype.attachEvent)),window.FormData=FormData=function(){return{append:function(a,b,c){b.__isFileAPIBlobShim&&(b=b.data[0]),this.data.push({key:a,val:b,name:c})},data:[],__isFileAPIShim:!0}},window.Blob=Blob=function(a){return{data:a,__isFileAPIBlobShim:!0}},function(){if(window.FileAPI||(window.FileAPI={}),FileAPI.forceLoad&&(FileAPI.html5=!1),!FileAPI.upload){var a,b,d,e,f,g=document.createElement("script"),h=document.getElementsByTagName("script");if(window.FileAPI.jsUrl)a=window.FileAPI.jsUrl;else if(window.FileAPI.jsPath)b=window.FileAPI.jsPath;else for(d=0;d<h.length;d++)if(f=h[d].src,e=f.search(/\/angular\-file\-upload[\-a-zA-z0-9\.]*\.js/),e>-1){b=f.substring(0,e+1);break}null==FileAPI.staticPath&&(FileAPI.staticPath=b),g.setAttribute("src",a||b+"FileAPI.min.js"),document.getElementsByTagName("head")[0].appendChild(g),FileAPI.hasFlash=c()}}(),FileAPI.disableFileInput=function(a,b){b?a.removeClass("js-fileapi-wrapper"):a.addClass("js-fileapi-wrapper")}}window.FileReader||(window.FileReader=function(){var a=this,b=!1;this.listeners={},this.addEventListener=function(b,c){a.listeners[b]=a.listeners[b]||[],a.listeners[b].push(c)},this.removeEventListener=function(b,c){a.listeners[b]&&a.listeners[b].splice(a.listeners[b].indexOf(c),1)},this.dispatchEvent=function(b){var c=a.listeners[b.type];if(c)for(var d=0;d<c.length;d++)c[d].call(a,b)},this.onabort=this.onerror=this.onload=this.onloadstart=this.onloadend=this.onprogress=null;var c=function(b,c){var d={type:b,target:a,loaded:c.loaded,total:c.total,error:c.error};return null!=c.result&&(d.target.result=c.result),d},d=function(d){if(b||(b=!0,a.onloadstart&&this.onloadstart(c("loadstart",d))),"load"===d.type){a.onloadend&&a.onloadend(c("loadend",d));var e=c("load",d);a.onload&&a.onload(e),a.dispatchEvent(e)}else if("progress"===d.type){var e=c("progress",d);a.onprogress&&a.onprogress(e),a.dispatchEvent(e)}else{var e=c("error",d);a.onerror&&a.onerror(e),a.dispatchEvent(e)}};this.readAsArrayBuffer=function(a){FileAPI.readAsBinaryString(a,d)},this.readAsBinaryString=function(a){FileAPI.readAsBinaryString(a,d)},this.readAsDataURL=function(a){FileAPI.readAsDataURL(a,d)},this.readAsText=function(a){FileAPI.readAsText(a,d)}})}(),function(){"use strict";var a=angular.module("ngImgCrop",[]);a.factory("cropAreaCircle",["cropArea",function(a){var b=function(){a.apply(this,arguments),this._boxResizeBaseSize=20,this._boxResizeNormalRatio=.9,this._boxResizeHoverRatio=1.2,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio,this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize=0,this._boxResizeIsHover=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!1,this._areaIsDragging=!1};return b.prototype=new a,b.prototype._calcCirclePerimeterCoords=function(a){var b=this._width/2,c=Math.floor(this._aspect[1]*(this._width/2)/this._aspect[0]),d=a*(Math.PI/180),e=this._x+b*Math.cos(d),f=this._y+c*Math.sin(d);return[e,f]},b.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)},b.prototype._isCoordWithinArea=function(a){return Math.sqrt((a[0]-this._x)*(a[0]-this._x)+(a[1]-this._y)*(a[1]-this._y))<this._width/2},b.prototype._isCoordWithinBoxResize=function(a){var b=this._calcResizeIconCenterCoords(),c=this._boxResizeHoverSize/2;return a[0]>b[0]-c&&a[0]<b[0]+c&&a[1]>b[1]-c&&a[1]<b[1]+c},b.prototype._drawArea=function(a,b,c,d){var e=b[0]-c/2,f=b[1]-d/2,g=.5522848,h=c/2*g,i=d/2*g,j=e+c,k=f+d,l=e+c/2,m=f+d/2;a.beginPath(),a.moveTo(e,m),a.bezierCurveTo(e,m-i,l-h,f,l,f),a.bezierCurveTo(l+h,f,j,m-i,j,m),a.bezierCurveTo(j,m+i,l+h,k,l,k),a.bezierCurveTo(l-h,k,e,m+i,e,m),a.stroke()},b.prototype.draw=function(){a.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio),this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)},b.prototype.processMouseMove=function(a,b){var c="default",d=!1,e=this._ctx.canvas.height,f=this._ctx.canvas.width;if(this._boxResizeIsHover=!1,this._areaIsHover=!1,this._areaIsDragging)this._x=a-this._posDragStartX,this._y=b-this._posDragStartY,this._areaIsHover=!0,c="move",d=!0,this._events.trigger("area-move");else if(this._boxResizeIsDragging){c="nesw-resize";var g=a-this._posResizeStartX,h=this._posResizeStartSize+g,i=this._width,j=this._height,k=this.getScale(),l=Math.ceil(k*this._minSize),m=Math.max(l,this._unscaledMinSize,h),n=Math.floor(this._aspect[1]*m/this._aspect[0]);if(m<=f&&n<=e){this._width=m,this._height=n;var o=(this._width-i)/2,p=(this._height-j)/2;this._x+=o,this._y+=p*-1,this._boxResizeIsHover=!0,d=!0,this._events.trigger("area-resize")}}else this._isCoordWithinBoxResize([a,b])?(c="nesw-resize",this._areaIsHover=!1,this._boxResizeIsHover=!0,d=!0):this._isCoordWithinArea([a,b])&&(c="move",this._areaIsHover=!0,d=!0);return this._dontDragOutside(),angular.element(this._ctx.canvas).css({cursor:c}),d},b.prototype.processMouseDown=function(a,b){this._isCoordWithinBoxResize([a,b])?(this._areaIsDragging=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!0,this._boxResizeIsHover=!0,this._posResizeStartX=a,this._posResizeStartY=b,this._posResizeStartSize=this._width,this._events.trigger("area-resize-start")):this._isCoordWithinArea([a,b])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._boxResizeIsDragging=!1,this._boxResizeIsHover=!1,this._posDragStartX=a-this._x,this._posDragStartY=b-this._y,this._events.trigger("area-move-start"))},b.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._boxResizeIsDragging&&(this._boxResizeIsDragging=!1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._boxResizeIsHover=!1,this._posDragStartX=0,this._posDragStartY=0},b}]),a.factory("cropAreaSquare",["cropArea",function(a){var b=function(){a.apply(this,arguments),this._resizeCtrlBaseRadius=10,this._resizeCtrlNormalRatio=.75,this._resizeCtrlHoverRatio=1,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio,this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartWidth=0,this._posResizeStartHeight=0,this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._resizeCtrlIsDragging=-1,this._areaIsDragging=!1};return b.prototype=new a,b.prototype._calcSquareCorners=function(){var a=this._width/2,b=this._height/2;return[[this._x-a,this._y-b],[this._x+a,this._y-b],[this._x-a,this._y+b],[this._x+a,this._y+b]]},b.prototype._calcSquareDimensions=function(){var a=this._width/2,b=this._height/2;return{left:this._x-a,top:this._y-b,right:this._x+a,bottom:this._y+b}},b.prototype._isCoordWithinArea=function(a){var b=this._calcSquareDimensions();return a[0]>=b.left&&a[0]<=b.right&&a[1]>=b.top&&a[1]<=b.bottom},b.prototype._isCoordWithinResizeCtrl=function(a){for(var b=this._calcSquareCorners(),c=-1,d=0,e=b.length;d<e;d++){var f=b[d];if(a[0]>f[0]-this._resizeCtrlHoverRadius&&a[0]<f[0]+this._resizeCtrlHoverRadius&&a[1]>f[1]-this._resizeCtrlHoverRadius&&a[1]<f[1]+this._resizeCtrlHoverRadius){c=d;break}}return c},b.prototype._drawArea=function(a,b,c,d){var e=c/2,f=d/2;a.rect(b[0]-e,b[1]-f,c,d)},b.prototype.draw=function(){a.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);for(var b=this._calcSquareCorners(),c=0,d=b.length;c<d;c++){var e=b[c];this._cropCanvas.drawIconResizeCircle(e,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===c?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}},b.prototype.processMouseMove=function(a,b){var c="default",d=!1,e=this._ctx.canvas.height,f=this._ctx.canvas.width;if(this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging)this._x=a-this._posDragStartX,this._y=b-this._posDragStartY,this._areaIsHover=!0,c="move",d=!0,this._events.trigger("area-move");else if(this._resizeCtrlIsDragging>-1){var g,h;switch(this._resizeCtrlIsDragging){case 0:g=-1,h=-1,c="nwse-resize";break;case 1:g=1,h=-1,c="nesw-resize";break;case 2:g=-1,h=1,c="nesw-resize";break;case 3:g=1,h=1,c="nwse-resize"}var i=(a-this._posResizeStartX)*g,j=this._posResizeStartWidth+i,k=this._width,l=this._height,m=this.getScale(),n=Math.ceil(m*this._minSize),o=Math.max(n,this._unscaledMinSize,j),p=Math.floor(this._aspect[1]*o/this._aspect[0]);if(o<=f&&p<=e){this._width=o,this._height=p;var q=(this._width-k)/2,r=(this._height-l)/2;this._x+=q*g,this._y+=r*h,this._resizeCtrlIsHover=this._resizeCtrlIsDragging,d=!0,this._events.trigger("area-resize")}}else{var s=this._isCoordWithinResizeCtrl([a,b]);if(s>-1){switch(s){case 0:c="nwse-resize";break;case 1:c="nesw-resize";break;case 2:c="nesw-resize";break;case 3:c="nwse-resize"}this._areaIsHover=!1,this._resizeCtrlIsHover=s,d=!0}else this._isCoordWithinArea([a,b])&&(c="move",this._areaIsHover=!0,d=!0)}return this._dontDragOutside(),angular.element(this._ctx.canvas).css({cursor:c}),d},b.prototype.processMouseDown=function(a,b){var c=this._isCoordWithinResizeCtrl([a,b]);c>-1?(this._areaIsDragging=!1,this._areaIsHover=!1,this._resizeCtrlIsDragging=c,this._resizeCtrlIsHover=c,this._posResizeStartX=a,this._posResizeStartY=b,this._posResizeStartWidth=this._width,this._posResizeStartHeight=this._height,this._events.trigger("area-resize-start")):this._isCoordWithinArea([a,b])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._resizeCtrlIsDragging=-1,this._resizeCtrlIsHover=-1,this._posDragStartX=a-this._x,this._posDragStartY=b-this._y,this._events.trigger("area-move-start"))},b.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._resizeCtrlIsDragging>-1&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},b}]),a.factory("cropArea",["cropCanvas",function(a){var b=function(b,c){this._ctx=b,this._events=c,this._minSize=80,this._unscaledMinSize=40,this._cropCanvas=new a(b),this._image=new Image,this._x=0,this._y=0,this._width=200,this._aspect=[1,1],this._height=Math.floor(this._aspect[1]*this._width/this._aspect[0])};return b.prototype.getImage=function(){return this._image},b.prototype.setImage=function(a){this._image=a},b.prototype.getX=function(){return this._x},b.prototype.setX=function(a){this._x=a,this._dontDragOutside()},b.prototype.getY=function(){return this._y},b.prototype.setY=function(a){this._y=a,this._dontDragOutside()},b.prototype.getSize=function(){return this._width},b.prototype.setSize=function(a){var b=this.getScale(),c=Math.round(b*this._minSize);this._width=Math.max(c,this._unscaledMinSize,a),this._height=Math.floor(this._aspect[1]*this._width/this._aspect[0]),this._dontDragOutside()},b.prototype.getWidth=function(){return this._width},b.prototype.setWidth=function(a){this.setSize(a)},b.prototype.getHeight=function(){return this._height},b.prototype.setHeight=function(a){var b=Math.floor(this._aspect[1]*this._minSize/this._aspect[0]),c=Math.max(b,a),d=Math.floor(this._aspect[0]*c/this._aspect[1]);this.setSize(d)},b.prototype.getMinSize=function(){return this._minSize},b.prototype.setMinSize=function(a){this._minSize=a,this._width=Math.max(this._minSize,this._width),this._height=Math.floor(this._aspect[1]*this._width/this._aspect[0]),this._dontDragOutside()},b.prototype.getAspect=function(){return this._aspect},b.prototype.setAspect=function(a,b){this._aspect=[a,b],this._dontDragOutside()},b.prototype.getScale=function(){var a=this._ctx.canvas.width/this._image.width,b=this._ctx.canvas.height/this._image.height;return!isNaN(a)&&!isNaN(b)&&isFinite(a)&&isFinite(b)||(a=1,b=1),Math.max(a,b)},b.prototype._dontDragOutside=function(){var a=this._ctx.canvas.height,b=this._ctx.canvas.width;this._width>b&&(this._width=b),this._height>a&&(this._height=a),this._x<this._width/2&&(this._x=this._width/2),this._x>b-this._width/2&&(this._x=b-this._width/2),this._y<this._height/2&&(this._y=this._height/2),this._y>a-this._height/2&&(this._y=a-this._height/2)},b.prototype._drawArea=function(){},b.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,[this._x,this._y],this._width,this._height,this._drawArea)},b.prototype.processMouseMove=function(){},b.prototype.processMouseDown=function(){},b.prototype.processMouseUp=function(){},b}]),a.factory("cropCanvas",[function(){var a=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]],b=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]],c=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]],d=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]],e=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]],f=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]],g=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]],h=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]],i={areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"};return function(j){var k=function(a,b,c){return[c*a[0]+b[0],c*a[1]+b[1]]},l=function(a,b,c,d){j.save(),j.fillStyle=b,j.beginPath();var e,f=k(a[0],c,d);j.moveTo(f[0],f[1]);for(var g in a)g>0&&(e=k(a[g],c,d),j.lineTo(e[0],e[1]));j.lineTo(f[0],f[1]),j.fill(),j.closePath(),j.restore()};this.drawIconMove=function(a,b){l(e,i.moveIconFill,a,b),l(f,i.moveIconFill,a,b),l(g,i.moveIconFill,a,b),l(h,i.moveIconFill,a,b)},this.drawIconResizeCircle=function(a,b,c){var d=b*c;j.save(),j.strokeStyle=i.resizeCircleStroke,j.lineWidth=2,j.fillStyle=i.resizeCircleFill,j.beginPath(),j.arc(a[0],a[1],d,0,2*Math.PI),j.fill(),j.stroke(),j.closePath(),j.restore()},this.drawIconResizeBoxBase=function(a,b,c){var d=b*c;j.save(),j.strokeStyle=i.resizeBoxStroke,j.lineWidth=2,j.fillStyle=i.resizeBoxFill,j.fillRect(a[0]-d/2,a[1]-d/2,d,d),j.strokeRect(a[0]-d/2,a[1]-d/2,d,d),j.restore()},this.drawIconResizeBoxNESW=function(a,d,e){this.drawIconResizeBoxBase(a,d,e),l(b,i.resizeBoxArrowFill,a,e),l(c,i.resizeBoxArrowFill,a,e)},this.drawIconResizeBoxNWSE=function(b,c,e){this.drawIconResizeBoxBase(b,c,e),l(a,i.resizeBoxArrowFill,b,e),l(d,i.resizeBoxArrowFill,b,e)},this.drawCropArea=function(a,b,c,d,e){var f=a.width/j.canvas.width,g=a.height/j.canvas.height,h=b[0]-c/2,k=b[1]-d/2;for(j.save(),j.strokeStyle=i.areaOutline,j.lineWidth=2,j.beginPath(),e(j,b,c,d),j.stroke(),j.clip();c*f>a.width;)c--;for(;d*g>a.height;)d--;c>0&&d>0&&j.drawImage(a,h*f,k*g,c*f,d*g,h,k,c,d),j.beginPath(),e(j,b,c,d),j.stroke(),j.clip(),j.restore()}}}]),a.service("cropEXIF",[function(){function a(a){return!!a.exifdata}function b(a,b){b=b||a.match(/^data\:([^\;]+)\;base64,/im)[1]||"",a=a.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var c=atob(a),d=c.length,e=new ArrayBuffer(d),f=new Uint8Array(e),g=0;g<d;g++)f[g]=c.charCodeAt(g);return e}function c(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="blob",c.onload=function(a){200!==this.status&&0!==this.status||b(this.response)},c.send()}function d(a,d){function g(b){var c=e(b),g=f(b);a.exifdata=c||{},a.iptcdata=g||{},d&&d.call(a)}if(a.src)if(/^data\:/i.test(a.src)){var h=b(a.src);g(h)}else if(/^blob\:/i.test(a.src)){var i=new FileReader;i.onload=function(a){g(a.target.result)},c(a.src,function(a){i.readAsArrayBuffer(a)})}else{var j=new XMLHttpRequest;j.onload=function(){if(200!==this.status&&0!==this.status)throw"Could not load image";g(j.response),j=null},j.open("GET",a.src,!0),j.responseType="arraybuffer",j.send(null)}else if(window.FileReader&&(a instanceof window.Blob||a instanceof window.File)){var i=new FileReader;i.onload=function(a){l&&console.log("Got file of length "+a.target.result.byteLength),g(a.target.result)},i.readAsArrayBuffer(a)}}function e(a){var b=new DataView(a);if(l&&console.log("Got file of length "+a.byteLength),255!==b.getUint8(0)||216!==b.getUint8(1))return l&&console.log("Not a valid JPEG"),!1;for(var c,d=2,e=a.byteLength;d<e;){if(255!==b.getUint8(d))return l&&console.log("Not a valid marker at offset "+d+", found: "+b.getUint8(d)),!1;if(c=b.getUint8(d+1),l&&console.log(c),225===c)return l&&console.log("Found 0xFFE1 marker"),k(b,d+4,b.getUint16(d+2)-2);d+=2+b.getUint16(d+2)}}function f(a){var b=new DataView(a);if(l&&console.log("Got file of length "+a.byteLength),255!==b.getUint8(0)||216!==b.getUint8(1))return l&&console.log("Not a valid JPEG"),!1;for(var c=2,d=a.byteLength,e=function(a,b){return 56===a.getUint8(b)&&66===a.getUint8(b+1)&&73===a.getUint8(b+2)&&77===a.getUint8(b+3)&&4===a.getUint8(b+4)&&4===a.getUint8(b+5)};c<d;){if(e(b,c)){var f=b.getUint8(c+7);f%2!==0&&(f+=1),0===f&&(f=4);var h=c+8+f,i=b.getUint16(c+6+f);return g(a,h,i)}c++}}function g(a,b,c){for(var d,e,f,g,h,i=new DataView(a),k={},l=b;l<b+c;)28===i.getUint8(l)&&2===i.getUint8(l+1)&&(g=i.getUint8(l+2),g in q&&(f=i.getInt16(l+3),h=f+5,e=q[g],d=j(i,l+5,f),k.hasOwnProperty(e)?k[e]instanceof Array?k[e].push(d):k[e]=[k[e],d]:k[e]=d)),l++;return k}function h(a,b,c,d,e){var f,g,h,j=a.getUint16(c,!e),k={};for(h=0;h<j;h++)f=c+12*h+2,g=d[a.getUint16(f,!e)],!g&&l&&console.log("Unknown tag: "+a.getUint16(f,!e)),k[g]=i(a,f,b,c,e);return k}function i(a,b,c,d,e){var f,g,h,i,k,l,m=a.getUint16(b+2,!e),n=a.getUint32(b+4,!e),o=a.getUint32(b+8,!e)+c;switch(m){case 1:case 7:if(1===n)return a.getUint8(b+8,!e);for(f=n>4?o:b+8,g=[],i=0;i<n;i++)g[i]=a.getUint8(f+i);return g;case 2:return f=n>4?o:b+8,j(a,f,n-1);case 3:if(1===n)return a.getUint16(b+8,!e);for(f=n>2?o:b+8,g=[],i=0;i<n;i++)g[i]=a.getUint16(f+2*i,!e);return g;case 4:if(1===n)return a.getUint32(b+8,!e);for(g=[],i=0;i<n;i++)g[i]=a.getUint32(o+4*i,!e);return g;case 5:if(1===n)return k=a.getUint32(o,!e),l=a.getUint32(o+4,!e),h=new Number(k/l),h.numerator=k,h.denominator=l,h;for(g=[],i=0;i<n;i++)k=a.getUint32(o+8*i,!e),l=a.getUint32(o+4+8*i,!e),g[i]=new Number(k/l),g[i].numerator=k,g[i].denominator=l;return g;case 9:if(1===n)return a.getInt32(b+8,!e);for(g=[],i=0;i<n;i++)g[i]=a.getInt32(o+4*i,!e);return g;case 10:if(1===n)return a.getInt32(o,!e)/a.getInt32(o+4,!e);for(g=[],i=0;i<n;i++)g[i]=a.getInt32(o+8*i,!e)/a.getInt32(o+4+8*i,!e);return g}}function j(a,b,c){for(var d="",e=b;e<b+c;e++)d+=String.fromCharCode(a.getUint8(e));return d}function k(a,b){if("Exif"!==j(a,b,4))return l&&console.log("Not valid EXIF data! "+j(a,b,4)),!1;var c,d,e,f,g,i=b+6;if(18761===a.getUint16(i))c=!1;else{if(19789!==a.getUint16(i))return l&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;c=!0}if(42!==a.getUint16(i+2,!c))return l&&console.log("Not valid TIFF data! (no 0x002A)"),!1;var k=a.getUint32(i+4,!c);if(k<8)return l&&console.log("Not valid TIFF data! (First offset less than 8)",a.getUint32(i+4,!c)),!1;if(d=h(a,i,i+k,n,c),d.ExifIFDPointer){f=h(a,i,i+d.ExifIFDPointer,m,c);for(e in f){switch(e){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":f[e]=p[e][f[e]];break;case"ExifVersion":case"FlashpixVersion":f[e]=String.fromCharCode(f[e][0],f[e][1],f[e][2],f[e][3]);break;case"ComponentsConfiguration":f[e]=p.Components[f[e][0]]+p.Components[f[e][1]]+p.Components[f[e][2]]+p.Components[f[e][3]]}d[e]=f[e]}}if(d.GPSInfoIFDPointer){g=h(a,i,i+d.GPSInfoIFDPointer,o,c);for(e in g){switch(e){case"GPSVersionID":g[e]=g[e][0]+"."+g[e][1]+"."+g[e][2]+"."+g[e][3]}d[e]=g[e]}}return d}var l=!1,m=this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},n=this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},o=this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},p=this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},q={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};this.getData=function(b,c){return!((b instanceof Image||b instanceof HTMLImageElement)&&!b.complete)&&(a(b)?c&&c.call(b):d(b,c),!0)},this.getTag=function(b,c){if(a(b))return b.exifdata[c]},this.getAllTags=function(b){if(!a(b))return{};var c,d=b.exifdata,e={};for(c in d)d.hasOwnProperty(c)&&(e[c]=d[c]);return e},this.pretty=function(b){if(!a(b))return"";var c,d=b.exifdata,e="";for(c in d)d.hasOwnProperty(c)&&(e+="object"==typeof d[c]?d[c]instanceof Number?c+" : "+d[c]+" ["+d[c].numerator+"/"+d[c].denominator+"]\r\n":c+" : ["+d[c].length+" values]\r\n":c+" : "+d[c]+"\r\n");return e},this.readFromBinaryFile=function(a){return e(a)}}]),a.factory("cropHost",["$document","$window","cropAreaCircle","cropAreaSquare","cropEXIF",function(a,b,c,d,e){var f=function(c){var d=c.getBoundingClientRect(),e=a[0].body,f=a[0].documentElement,g=b.pageYOffset||f.scrollTop||e.scrollTop,h=b.pageXOffset||f.scrollLeft||e.scrollLeft,i=f.clientTop||e.clientTop||0,j=f.clientLeft||e.clientLeft||0,k=d.top+g-i,l=d.left+h-j;return{top:Math.round(k),left:Math.round(l)}};return function(b,e,g){function h(){i.clearRect(0,0,i.canvas.width,i.canvas.height),
null!==j&&(i.drawImage(j,0,0,i.canvas.width,i.canvas.height),i.save(),i.fillStyle="rgba(0, 0, 0, 0.65)",i.fillRect(0,0,i.canvas.width,i.canvas.height),i.restore(),k.draw())}var i=null,j=null,k=null,l=[100,100],m=[300,300],n=200,o=[1,1],p=n,q=Math.floor(o[1]*p/o[0]),r="image/png",s=null,t=function(a,c){if(null!==j){k.setImage(j);var d,e,f,g,n=[j.width,j.height],p=j.width/j.height,q=n;if(q[0]>m[0]?(q[0]=m[0],q[1]=q[0]/p):q[0]<l[0]&&(q[0]=l[0],q[1]=q[0]/p),q[1]>m[1]?(q[1]=m[1],q[0]=q[1]*p):q[1]<l[1]&&(q[1]=l[1],q[0]=q[1]*p),b.prop("width",q[0]).prop("height",q[1]).css({"margin-left":-q[0]/2+"px","margin-top":-q[1]/2+"px"}),d=i.canvas.width/2,e=i.canvas.height/2,a?(f=i.canvas.width-1,g=Math.floor(o[1]*f/o[0])):(f=.75*i.canvas.width,g=Math.floor(o[1]*f/o[0]),g>.75*i.canvas.height&&(g=.75*i.canvas.height,f=Math.floor(o[0]*g/o[1]))),"undefined"!=typeof c&&"undefined"!=typeof c.width&&c.width>0){var r=i.canvas.width/j.width;f=Math.round(c.width*r),f>i.canvas.width&&(f=i.canvas.width-1),g=Math.floor(o[1]*f/o[0]),d=Math.round(c.x*r+f/2),e=Math.round(c.y*r+g/2)}g>i.canvas.height&&(g=i.canvas.height-1,f=Math.floor(o[0]*g/o[1])),d+f/2>i.canvas.width&&(d=Math.floor(i.canvas.width-f/2)),e+g/2>i.canvas.height&&(e=Math.floor(i.canvas.height-g/2)),k.setX(d),k.setY(e),k.setSize(f)}else b.prop("width",0).prop("height",0).css({"margin-top":0});h()},u=function(a){return angular.isDefined(a.changedTouches)?a.changedTouches:a.originalEvent.changedTouches},v=function(a){if(null!==j){var b,c,d=f(i.canvas);"touchmove"===a.type?(b=u(a)[0].pageX,c=u(a)[0].pageY):(b=a.pageX,c=a.pageY),k.processMouseMove(b-d.left,c-d.top),h()}},w=function(a){if(a.preventDefault(),a.stopPropagation(),null!==j){var b,c,d=f(i.canvas);"touchstart"===a.type?(b=u(a)[0].pageX,c=u(a)[0].pageY):(b=a.pageX,c=a.pageY),k.processMouseDown(b-d.left,c-d.top),h()}},x=function(a){if(null!==j){var b,c,d=f(i.canvas);"touchend"===a.type?(b=u(a)[0].pageX,c=u(a)[0].pageY):(b=a.pageX,c=a.pageY),k.processMouseUp(b-d.left,c-d.top),h()}};this.getResultImageDataURI=function(){var a,b;if(b=angular.element("<canvas></canvas>")[0],a=b.getContext("2d"),b.width=p,b.height=q,null!==j){for(var c=k.getWidth(),d=k.getHeight(),e=j.width/i.canvas.width,f=j.height/i.canvas.height,g=k.getX()-c/2,h=k.getY()-d/2;c*e>j.width;)c--;for(;d*f>j.height;)d--;a.drawImage(j,g*e,h*f,c*e,d*f,0,0,p,q)}return null!==s?b.toDataURL(r,s):b.toDataURL(r)},this.setNewImageSource=function(a,b,c){if(j=null,t(b),g.trigger("image-updated"),a){var d=new Image;"http"===a.substring(0,4).toLowerCase()&&(d.crossOrigin="anonymous"),d.onload=function(){g.trigger("load-done"),j=d,t(b,c),g.trigger("image-updated")},d.onerror=function(){g.trigger("load-error")},g.trigger("load-start"),d.src=a}},this.setMaxDimensions=function(a,c){if(m=[a,c],null!==j){if(b[0].clientHeight>0){var d=i.canvas.width,e=i.canvas.height,f=[j.width,j.height],g=j.width/j.height,n=f;n[0]>m[0]?(n[0]=m[0],n[1]=n[0]/g):n[0]<l[0]&&(n[0]=l[0],n[1]=n[0]/g),n[1]>m[1]?(n[1]=m[1],n[0]=n[1]*g):n[1]<l[1]&&(n[1]=l[1],n[0]=n[1]*g),b.prop("width",n[0]).prop("height",n[1]).css({"margin-left":-n[0]/2+"px","margin-top":-n[1]/2+"px"});var o=i.canvas.width/d,p=i.canvas.height/e,q=Math.min(o,p);k.setX(k.getX()*o),k.setY(k.getY()*p),k.setSize(k.getSize()*q)}}else b.prop("width",0).prop("height",0).css({"margin-top":0});h()},this.setAreaMinSize=function(a){a=parseInt(a,10),isNaN(a)||(k.setMinSize(a),h())},this.setResultImageSize=function(a){a=parseInt(a,10),isNaN(a)||(n=a,p=n,q=Math.floor(o[1]*p/o[0]))},this.setResultImageAspect=function(a,b){if(a=parseInt(a,10),b=parseInt(b,10),!isNaN(a)&&!isNaN(b)){k.setAspect(a,b);var c=k.getWidth();k.setSize(c),o=[a,b],q=Math.floor(o[1]*p/o[0])}},this.setResultImageFormat=function(a){r=a},this.setResultImageQuality=function(a){a=parseFloat(a),!isNaN(a)&&a>=0&&a<=1&&(s=a)},this.setAreaType=function(a){var b=k.getSize(),e=k.getMinSize(),f=k.getX(),l=k.getY(),m=k.getAspect(),n=c;"square"===a&&(n=d),k=new n(i,g),k.setAspect(m[0],m[1]),k.setMinSize(e),k.setSize(b),k.setX(f),k.setY(l),null!==j&&k.setImage(j),h()},this.getArea=function(){return k},this.getCanvas=function(){return i.canvas},this.getImageWidth=function(){return null!==j?j.width:0},this.getImageHeight=function(){return null!==j?j.height:0},i=b[0].getContext("2d"),k=new c(i,g),a.on("mousemove",v),b.on("mousedown",w),a.on("mouseup",x),a.on("touchmove",v),b.on("touchstart",w),a.on("touchend",x),this.destroy=function(){a.off("mousemove",v),b.off("mousedown",w),a.off("mouseup",v),a.off("touchmove",v),b.off("touchstart",w),a.off("touchend",v),b.remove()}}}]),a.factory("cropPubSub",[function(){return function(){var a={};this.on=function(b,c){return b.split(" ").forEach(function(b){a[b]||(a[b]=[]),a[b].push(c)}),this},this.trigger=function(b,c){return angular.forEach(a[b],function(a){a.call(null,c)}),this}}}]),a.directive("imgCrop",["$timeout","cropHost","cropPubSub",function(a,b,c){return{restrict:"E",scope:{image:"=",resultImage:"=",originalData:"=",cropData:"=",changeOnFly:"=",areaType:"@",areaMinSize:"=",resultImageSize:"=",resultImageAspect:"@",resultImageFormat:"@",resultImageQuality:"=",maximizeCrop:"=",onChange:"&",onLoadBegin:"&",onLoadDone:"&",onLoadError:"&"},template:"<canvas></canvas>",controller:["$scope",function(a){a.events=new c}],link:function(c,d,e){var f,g=c.events,h=!0,i=new b(d.find("canvas"),{},g),j=function(a){if(""!==a.image){var b=i.getImageWidth(),c=i.getImageHeight(),d=i.getArea(),e=i.getCanvas(),g=d.getAspect(),h=Math.floor(d.getWidth()*g[1]/g[0]);if(h>e.height&&d.setHeight(e.height),angular.isDefined(a.cropData)&&0!==b){var j=b/e.width;a.cropData={width:Math.round(d.getWidth()*j),height:Math.round(d.getHeight()*j),x:Math.round((d.getX()-d.getWidth()/2)*j),y:Math.round((d.getY()-d.getHeight()/2)*j)}}if(angular.isDefined(a.originalData)&&0!==b&&0!==c&&(a.originalData={width:b,height:c}),angular.isDefined(a.resultImage)){var k=i.getResultImageDataURI();f!==k&&(f=k,angular.isDefined(a.resultImage)&&(a.resultImage=k),a.onChange({$dataURI:a.resultImage}))}}},k=function(b){return function(){a(function(){c.$apply(function(a){b(a)})})}};g.on("load-start",k(function(a){a.onLoadBegin({})})).on("load-done",k(function(a){a.onLoadDone({})})).on("load-error",k(function(a){a.onLoadError({})})).on("area-move area-resize",k(function(a){a.changeOnFly&&j(a)})).on("area-move-end area-resize-end image-updated",k(function(a){j(a)})),c.$watch("image",function(){var b={};a(function(){var a=!!c.maximizeCrop;angular.isDefined(c.cropData)&&(b=c.cropData),i.setNewImageSource(c.image,a,b)},100)}),c.$watch("areaType",function(){i.setAreaType(c.areaType),j(c)}),c.$watch("areaMinSize",function(){i.setAreaMinSize(c.areaMinSize),j(c)}),c.$watch("resultImageSize",function(){i.setResultImageSize(c.resultImageSize),j(c)}),c.$watch("resultImageAspect",function(){if("undefined"!=typeof c.resultImageAspect){var a=c.resultImageAspect.toLowerCase().split("x");2!==a.length||isNaN(parseInt(a[0],10))||isNaN(parseInt(a[1],10))||(i.setResultImageAspect(parseInt(a[0],10),parseInt(a[1],10)),j(c))}}),c.$watch("resultImageFormat",function(){i.setResultImageFormat(c.resultImageFormat),j(c)}),c.$watch("resultImageQuality",function(){i.setResultImageQuality(c.resultImageQuality),j(c)}),c.$watch("maximizeCrop",function(){var a=!!c.maximizeCrop;angular.isDefined(c.image)&&!h?i.setNewImageSource(c.image,a):h=!1}),c.$watch(function(){return[d[0].clientWidth,d[0].clientHeight]},function(a){i.setMaxDimensions(a[0],a[1]),j(c)},!0),c.$on("$destroy",function(){i.destroy()})}}}]),a.directive("imgCropResult",function(){return{restrict:"A",scope:{image:"=",cropData:"=",originalData:"=",width:"@"},template:'<div class="imgCropResultContainer"><img /></div>',link:function(a,b,c){var d,e,f=angular.element(b[0].querySelector(".imgCropResultContainer")),g=b.find("img")[0],h=0,i=0,j=0,k=function(){angular.isDefined(a.image)&&""!==a.image&&angular.isDefined(a.cropData)&&"undefined"!=typeof a.cropData.width&&l()},l=function(){var b,c=Math.round(100*a.cropData.width/a.cropData.height);c!==e&&(e=c,j=Math.round(1e5*a.cropData.height/a.cropData.width)/1e3,f.css({"padding-top":j+"%"})),a.image!==d?(d=a.image,angular.isDefined(a.originalData)&&"undefined"!=typeof a.originalData.width&&0!==a.originalData.width?(h=a.originalData.width,i=a.originalData.height,m()):(b=new Image,b.onload=function(){h=b.width,i=b.height,m()},b.src=a.image),g.src=a.image):m()},m=function(){var b=Math.round(1e5*h/a.cropData.width)/1e3,c=Math.round(1e5*i/a.cropData.height)/1e3,d=Math.floor(1e3*b*a.cropData.x/h)*-1/1e3,e=Math.floor(1e3*c*a.cropData.y/i)*-1/1e3;angular.element(g).css({width:b+"%",left:d+"%",top:e+"%"})};a.$watch("image",function(){k()}),a.$watch("cropData",function(){k()}),a.$watch("width",function(){var c=parseFloat(a.width)!==parseInt(a.width)||isNaN(a.width)?"":"px";b.css({width:a.width+c})})}}})}(),function(a){"use strict";var b=a.module("components.files.images.crop",["ngImgCrop"]);b.constant("PROFILE_IMAGE_CROP_TOOL_COLORS",{areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"}),b.config(["$provide","PROFILE_IMAGE_CROP_TOOL_COLORS",function(a,b){a.decorator("cropArea",["$delegate",function(a){var b=!1,c=function(c,d){return a.apply(this,arguments),d&&d.on("image-updated",function(){b=!1}.bind(this)),this};return c.prototype=new a,c.prototype.draw=function(){!b&&this._cropCanvas.coord&&(this._events.trigger("init-area",this._cropCanvas.coord),b=!0),this._cropCanvas.drawCropArea(this._image,[this._x,this._y],this._width,this._aspect,this._drawArea)},c}]),a.decorator("cropAreaSquare",["$delegate",function(a){var b=function(){return a.apply(this,arguments),this};return b.prototype=new a,b.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end",this._cropCanvas.coord)),this._resizeCtrlIsDragging>-1&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end",this._cropCanvas.coord)),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},b}]),a.decorator("cropAreaCircle",["$delegate",function(a){var b=function(){return a.apply(this,arguments),this};return b.prototype=new a,b.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end",this._cropCanvas.coord)),this._boxResizeIsDragging&&(this._boxResizeIsDragging=!1,this._events.trigger("area-resize-end",this._cropCanvas.coord)),this._areaIsHover=!1,this._boxResizeIsHover=!1,this._posDragStartX=0,this._posDragStartY=0},b}]),a.decorator("cropCanvas",["$delegate",function(a){var c=function(c){a.call(this,c),this.setCropCoord=function(a,b,c,d){this.coord={x:a,y:b,width:c,height:d}},this.drawCropArea=function(a,d,e,f,g){var h=Math.floor(e*f[1]/f[0]),i=a.width/c.canvas.width,j=a.height/c.canvas.height,k=d[0]-e/2,l=d[1]-h/2;if(c.save(),c.strokeStyle=b.areaOutline,c.lineWidth=2,c.beginPath(),g(c,d,e,h),c.stroke(),c.clip(),e>0){var m=k*i,n=l*j,o=e*i,p=h*j;c.drawImage(a,m,n,o,p,k,l,e,h),this.setCropCoord(m,n,o,p)}c.beginPath(),g(c,d,e,h),c.stroke(),c.clip(),c.restore()}};return c.prototype=new a,c}]),a.decorator("imgCropDirective",["$delegate","$timeout","$parse","eoImageCropCoord",function(a,b,c,d){var e=a[0],f=e.compile;return e.compile=function(a,c){var e=f.apply(this,arguments);return function(a,c,f){e.apply(this,arguments),a.events.on("area-move-end area-resize-end",function(c){b(function(){a.$apply(function(){d.set(c),a.cropCoord=c})})}).on("init-area",function(c){b(function(){a.$apply(function(){d.set(c),a.cropCoord=c})})})}},a}])}]),b.directive("eoImageCrop",[function(){return{templateUrl:"ImageCrop.tmpl.html",scope:{image:"=",resultImage:"=",cropCoord:"=?",changeOnFly:"=",areaType:"@",areaMinSize:"=",resultImageSize:"=",resultImageFormat:"@",resultImageQuality:"=",resultImageAspect:"@",onChange:"&",onLoadBegin:"&",onLoadDone:"&",onLoadError:"&"}}}]),b.service("eoImageCropCoord",[function(){var a={};return{set:function(b){return a=b},get:function(){return a}}}])}(angular),function(a){"use strict";var b=a.module("components.uploading.helpers.image",["ngImgCrop","components.core.utils"]);b.service("eoImageHelper",["$q","$rootScope","$document","cropEXIF","eoUtils",function(b,c,d,e,f){return{dataURItoBlob:function(b,c){for(var d=atob(b.split(",")[1]),e=[],f=d.length,g=0;g<f;g++)e.push(d.charCodeAt(g));var h=a.extend({},c);return new Blob([new window.Uint8Array(e)],h)},apllyRotationFromEXIF:function(b,c,f){function g(b,c,d,e,f){var g=[3,6,8].indexOf(d)>-1,h=[6,8].indexOf(d)>-1,i=b.getContext("2d"),j=0;switch(d){case 3:f.cx=-c.width,f.cy=-c.height,j=180;break;case 6:f.cw=c.height,f.ch=c.width,f.cy=-c.height,j=90;break;case 8:f.cw=c.height,f.ch=c.width,f.cx=-c.width,j=270}if(a.isDefined(e)&&(f.cw>f.ch?(e>f.cw&&(e=f.cw),i.scale(e/f.cw,e/f.cw),f.cx=e/f.cw*f.cx,f.cy=e/f.cw*f.cy,f.ch=e/f.cw*f.ch,f.cw=e):(e>f.ch&&(e=f.ch),i.scale(e/f.ch,e/f.ch),f.cx=e/f.ch*f.cx,f.cy=e/f.ch*f.cy,f.cw=e/f.ch*f.cw,f.ch=e)),b.width=f.cw,b.height=f.ch,g&&i.rotate(j*Math.PI/180),h){var k=f.ch;f.ch=f.cw,f.cw=k}}function h(a,b,c,e){var f=new Image,h=d[0].createElement("canvas"),i=h.getContext("2d");f.onload=function(){var a={cw:f.width,ch:f.height,cx:0,cy:0};g(h,f,c,void 0,a),i.drawImage(f,a.cx,a.cy);var b=h.toDataURL("image/png");g(h,f,c,226,a),i.drawImage(f,a.cx,a.cy,a.cw,a.ch);var d=h.toDataURL("image/png");e&&e(b,d,c)},f.src=b}e.getData(b,function(){var a=e.getTag(b,"Orientation");h(b,c,a,f)})},loadImageByUrl:function(a){var d=b.defer(),e=f.parseUrl(a),g=f.parseUrl(document.location.href),h=new Image;""===e.host||e.host===g.host&&e.protocol===g.protocol&&e.port===g.port||h.setAttribute("crossOrigin","anonymous"),h.onerror=function(a){d.reject(a)},h.onload=function(a){var b=document.createElement("canvas");b.width=this.width,b.height=this.height;var c=b.getContext("2d");c.drawImage(this,0,0);try{d.resolve(b.toDataURL("image/png"))}catch(e){d.reject(e)}};try{h.src=a,c.$evalAsync(function(){d.notify({})})}catch(i){d.reject(i)}return d.promise}}}])}(angular),function(){"use strict";var a=angular.module("components.uploading.helpers.models",["components.core.model"]);a.run(["eoModelRegistry",function(a){var b=a.get("Base"),c=a.get("Exception"),d=b.extend({name:"",file:null,progress:-1,response:null,init:function(a){"undefined"!=typeof a&&this._super(a)}});a.put("FileUpload",d);var e=b.extend({type:"",name:"",size:0,file_key:"",init:function(a){"undefined"!=typeof a&&this._super(a)}});a.put("WebStorageUpload",e),a.put("UploadTypeException",c.extend({}))}])}(),function(a){"use strict";var b=a.module("components.uploading.helpers",[]);b.config([function(){!window.XMLHttpRequest||window.FileAPI&&window.FileAPI.shouldLoad||(window.XMLHttpRequest.prototype.setRequestHeader=function(a){return function(b,c,d){if("__setXHR_"===b){var e=c(this);e instanceof Function&&e(this)}else a.apply(this,arguments)}}(window.XMLHttpRequest.prototype.setRequestHeader))}]),b.service("eoUpload",["$http","$q","$timeout",function(b,c,d){function e(a){a.method=a.method||"POST",a.headers=a.headers||{},a.transformRequest=a.transformRequest||function(a,c){return window.ArrayBuffer&&a instanceof window.ArrayBuffer?a:b.defaults.transformRequest[0](a,c)};var e=c.defer();!window.XMLHttpRequest||window.FileAPI&&window.FileAPI.shouldLoad||(a.headers.__setXHR_=function(){return function(b){b&&(a.__XHR=b,a.xhrFn&&a.xhrFn.constructor===Function&&a.xhrFn(b),b.upload.addEventListener("progress",function(a){e.notify(a)},!1),b.upload.addEventListener("load",function(a){a.lengthComputable&&e.notify(a)},!1))}}),b(a).then(function(a){e.resolve(a)},function(a){e.reject(a)},function(a){e.notify(a)});var f=e.promise;return f.success=function(b){return f.then(function(c){b(c.data,c.status,c.headers,a)}),f},f.progress=function(a){return f.then(null,null,function(b){a(b)}),f},f.error=function(b){return f.then(null,function(c){b(c.data,c.status,c.headers,a)}),f},f.abort=function(){return a.__XHR&&d(function(){a.__XHR.abort()}),f},f.xhr=function(b){return a.xhrFn=function(a){return function(){a&&a.apply(f,arguments),b.apply(f,arguments)}}(a.xhrFn),f},f.then=function(b,c){return function(d,e,f){a.progress=f||a.progress;var g=c.apply(b,[d,e,f]);return g.abort=b.abort,g.progress=b.progress,g.xhr=b.xhr,g.then=b.then,g}}(f,f.then),f}return{upload:function(c){c.headers=c.headers||{},c.headers["Content-Type"]=void 0,c.transformRequest=c.transformRequest||b.defaults.transformRequest;var d=new FormData,f=c.transformRequest,g=c.data;return c.transformRequest=function(b,d){if(g&&(c.formDataAppender?a.forEach(g,function(a,d){c.formDataAppender(b,d,a)}):a.forEach(g,function(c,e){if(a.isFunction(f))c=f(c,d);else for(var g=0;g<f.length;g++){var h=f[g];a.isFunction(h)&&(c=h(c,d))}b.append(e,c)})),null!==c.file){var e=c.fileFormDataName||"file";if(a.isArray(c.file))for(var h=a.isString(e),i=0;i<c.file.length;i++)b.append(h?e+i:e[i],c.file[i],c.file[i].name);else b.append(e,c.file,c.file.name)}return b},c.data=d,e(c)},http:function(a){return e(a)}}}]),b.directive("eoFileSelect",["$parse",function(a){return{restrict:"A",scope:{onSelect:"&eoFileSelect"},link:function(a,b,c){b.on("change",function(b){var c=[],d=b.target.files;null!==d&&Array.prototype.push.apply(c,d),a.$apply(function(){a.onSelect({$files:c,$event:b})})})}}}]),b.directive("eoFileDrop",["$parse",function(a){return{restrict:"A",scope:{onSelect:"&eoFileDrop"},link:function(a,b,c){window.FileReader&&(b.on("dragover",function(a){b.addClass("dragover"),a.stopPropagation(),a.preventDefault()}),b.on("dragleave",function(a){b.removeClass("dragover"),a.stopPropagation(),a.preventDefault()}),b.on("drop",function(c){b.removeClass("dragover"),c.stopPropagation(),c.preventDefault();var d=null;c.dataTransfer?d=c.dataTransfer.files:c.originalEvent&&c.originalEvent.dataTransfer&&(d=c.originalEvent.dataTransfer.files);var e=[];null!==d&&Array.prototype.push.apply(e,d),a.$apply(function(){a.onSelect({$event:c,$files:e})})}))}}}])}(angular),function(a){"use strict";var b=a.module("components.uploading.uploaders.file",["components.uploading.helpers","components.core.popover","components.core.modal","components.core.config","components.core.block","components.uploading.helpers.models"]);b.constant("DROPBOX_APP_KEY","lss047vujjt0bir"),b.constant("FILE_UPLOAD_URL","/api/files/v1/tmp.xhtml"),b.constant("DROPBOX_UPLOAD_URL","/api/files/v1/webstorage.json"),b.directive("eoFileUploadList",["eoUpload","eoConfig","$window","$http","eoModelFactory","eoBlockWatcher","DROPBOX_APP_KEY","eoModal","FILE_UPLOAD_URL","DROPBOX_UPLOAD_URL",function(b,c,d,e,f,g,h,i,j,k){var l=function(){if(!d.Dropbox){var a=document.createElement("script");a.type="text/javascript",a.id="dropboxjs",a.setAttribute("data-app-key",h),a.async=!1,a.src="https://www.dropbox.com/static/api/2/dropins.js",document.getElementsByTagName("head")[0].appendChild(a)}};return{restrict:"A",require:"?^form",scope:{onComplete:"&eoFileUploadList",preloadedFiles:"="},link:function(b,c,d,e){if(l(),b.closePopover=function(){setTimeout(function(){c.children().eq(1).triggerHandler("click")},0)},b.requestWatch=new g,e&&b.$watch("requestWatch.pending",function(a){e.$setValidity("uploadingFile",!a)}),b.preloadedFiles&&b.preloadedFiles.length>0){var h=[];a.forEach(b.preloadedFiles,function(a){var b=new File([""],a.name,a),c=f.get("FileUpload",{file:b,progress:100});h.push(c)}),b.onComplete({$files:h})}},controller:["$scope",function(g){var h=a.extend(c.get("env")||{},{USER_MAX_FILE_UPLOAD:26214400});g.selectedFiles=[],g.uploadedFiles=[],g.$watchCollection("uploadedFiles",function(a){a.length===g.selectedFiles.length&&g.onComplete({$files:a})});var l=function(b){return function(c){var d=null;if(c.constructor===String){var e=c.replace(/(<([^>]+)>)/gi,"");d=a.fromJson(e)}else d=c;g.selectedFiles[b].response=d,201===+d.code?(g.selectedFiles[b].progress=100,g.uploadedFiles.push(g.selectedFiles[b])):400===+d.code?(g.selectedFiles[b].error=d,i.simple({locals:{_header:"Empty attachment",_body:d.message}})):413===+d.code?(g.selectedFiles[b].error=d,i.simple({locals:{_header:"Attachment size limit exceeded",_body:d.message}})):500===+d.code&&(g.selectedFiles[b].error=d,i.simple({locals:{_header:"Internal Server Error",_body:d.message}}))}},m=function(a){return function(b){g.selectedFiles[a].error=b}};g.uploadFile=function(c){a.forEach(c,function(a){if(a.size<=h.USER_MAX_FILE_UPLOAD){var c=f.get("FileUpload",{file:a,progress:-1,dataUrl:null}),d=g.selectedFiles.push(c)-1;g.requestWatch.wait(b.upload({url:j,file:a,fileFormDataName:"attachment"}).success(l(d)).progress(function(a){g.selectedFiles[d].progress=parseInt(100*a.loaded/a.total)}).error(m(d)))}else i.simple({locals:{_header:"Too big",_body:"Your file is too big"}})}),g.closePopover()},g.chooseFromDropbox=function(){d.Dropbox.choose({success:function(b){g.$apply(function(){a.forEach(b,function(a){if(a.bytes<=h.USER_MAX_FILE_UPLOAD){var b=f.get("FileUpload",{file:a,progress:-1,dataUrl:null}),c=g.selectedFiles.push(b)-1,d=f.get("WebStorageUpload",{type:"dropbox",name:a.name,size:a.bytes,file_key:a.link});g.requestWatch.wait(e({method:"POST",url:k,data:d.toFormData(),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(l(c)).error(m(c)))}else i.simple({locals:{_header:"Too big",_body:"Your file is too big"}})})})},linkType:"direct",multiselect:!0}),g.closePopover()},g.removeSelectedFile=function(a){g.selectedFiles.splice(a,1)}}],templateUrl:"FileUploadList.tmpl.html"}}])}(angular),function(a){"use strict";var b=a.module("components.uploading.uploaders.imageDrop",["components.uploading.helpers","components.core.block","components.uploading.helpers.image"]);b.constant("IMAGEDROP_UPLOAD_URL","/upload"),b.constant("IMAGE_ACCEPTED_TYPES",{"image/png":!0,"image/jpeg":!0,"image/gif":!0}),b.directive("eoImageDrop",["$parse","$compile","$window","eoUpload","eoImageHelper","IMAGEDROP_UPLOAD_URL","IMAGE_ACCEPTED_TYPES",function(b,c,d,e,f,g,h){return{restrict:"A",templateUrl:"ImageDrop.tmpl.html",require:"?^ngModel",transclude:!0,scope:{onSelect:"&eoImageDrop",onUpload:"&eoImageDropOnUpload",onError:"&eoImageDropOnError",onProgress:"&eoImageDropOnProgress"},link:function(b,c,i,j){function k(a,c){var d=function(d){b.onUpload({$file:a,$result:d}),c.status="success",c.result=d,o(b.files)},f=function(d){b.onError({$file:a,$result:d}),c.status="error",c.result=d,o(b.files)};e.upload({url:g,file:a,data:{}}).then(d,f)}function l(a,c){if("undefined"!==d.FileReader&&p[a.type]===!0){var e=new FileReader;e.addEventListener("load",function(d){var e=d.target.result,g={preview:n,original:n,status:"loading",file:a};b.files.push(g),o(b.files),b.$apply();var h=b.files.length-1;f.apllyRotationFromEXIF(a,e,function(a,d,e){b.files[h].preview=d,b.files[h].file=f.dataURItoBlob(g.original),o(b.files),b.$apply(),c&&c(g)})}),e.readAsDataURL(a)}}function m(c,d){a.forEach(c,function(a){l(a,function(b){k(a,b)})}),b.onSelect({$event:event,$files:c}),d!==!1&&b.$apply()}var n="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";b.files=[];var o=function(a){b.files=a,j?j.$setViewValue(b.files):b.$$phase&&b.$apply()},p=h||{},q=function(){var a=document.createElement("div");return"draggable"in a||"ondragstart"in a&&"ondrop"in a};c.addClass("eo-image-drop");var r=c.find("input"),s=c;i.eoUploadLink&&(s=a.element(c[0].querySelector(i.eoUploadLink))),s.on("click",function(){r[0].click()}),b.removeFile=function(a){b.files.splice(a,1),o(b.files)},b.fileSelected=function(a){m(a,!1)},d.FileReader&&q&&(c.on("dragover",function(a){c.addClass("dragover"),a.stopPropagation(),a.preventDefault()}),c.on("dragleave",function(a){c.removeClass("dragover"),a.stopPropagation(),a.preventDefault()}),c.on("drop",function(a){c.removeClass("dragover"),a.stopPropagation(),a.preventDefault();var b=null;a.dataTransfer?b=a.dataTransfer.files:a.originalEvent&&a.originalEvent.dataTransfer&&(b=a.originalEvent.dataTransfer.files),m(b)}))}}}]),b.directive("eoImageDropPreview",["$parse","eoUpload","IMAGEDROP_UPLOAD_URL",function(a,b,c){return{restrict:"A",scope:!0,link:function(b,c,d){var e=a(d.eoImageDropPreview),f=e(b);f.id="eo-image-drop-preview-"+b.$id,e.assign(b,f),c.addClass("eo-image-drop-preview"),c.attr("id","eo-image-drop-preview-"+b.$id)}}}])}(angular),function(a){"use strict";var b=a.module("components.uploading.uploaders.profileImage",["components.uploading.helpers","components.files.images.crop","components.uploading.helpers.image","components.core.model","components.core.block"]);b.constant("PROFILE_IMAGE_AREA_TYPE","circle"),b.constant("PROFILE_IMAGE_UPLOAD_URL","/upload"),b.constant("PROFILE_IMAGE_TYPE_REGEXP",/^image\/(png|gif|jpeg)$/),b.constant("PROFILE_IMAGE_ACCEPT","image/png,image/gif,image/jpeg"),b.service("eoTemplateImageService",[function(){var a={};this.set=function(b,c){a[b]=c},this.get=function(b){return a[b]}}]),b.config(["$provide","PROFILE_IMAGE_CROP_TOOL_COLORS",function(a,b){a.decorator("cropCanvas",["$delegate","eoTemplateImageService",function(a,c){var d=c.get("profile_image_outline"),e=function(c){return a.call(this,c),this.drawCropArea=function(a,d,e,f,g){var h=Math.floor(e*f[1]/f[0]),i=a.width/c.canvas.width,j=a.height/c.canvas.height,k=d[0]-e/2,l=d[1]-h/2;if(c.save(),c.setLineDash([5]),c.strokeStyle=b.areaOutline,c.lineWidth=2,c.beginPath(),g(c,d,e,h),c.stroke(),c.clip(),e>0){var m=k*i,n=l*j,o=e*i,p=h*j;c.drawImage(a,m,n,o,p,k,l,e,h),this.setCropCoord(m,n,o,p)}c.beginPath(),g(c,d,e,h),c.stroke(),c.clip(),c.restore(),this.drawGuide(c,d,e,h)},this.drawGuide=function(a,b,c,e){if(d){var f=c>e?e:c,g=b[0]-c/2,h=b[1]-e/2;a.save(),a.globalAlpha=.8,a.drawImage(d,g,h,f,f),a.restore()}},this.drawIconResizeCircle=function(a,d,e){c.save(),c.strokeStyle=b.resizeCircleStroke,c.lineWidth=1,c.fillStyle=b.resizeCircleFill,c.beginPath(),c.fillRect(a[0]-d/2,a[1]-d/2,d,d),c.strokeRect(a[0]-d/2,a[1]-d/2,d,d),c.fill(),c.stroke(),c.closePath(),c.restore()},this};return e}])}]),b.directive("eoProfileImageUploader",["eoUpload","PROFILE_IMAGE_AREA_TYPE","PROFILE_IMAGE_UPLOAD_URL","PROFILE_IMAGE_TYPE_REGEXP","eoImageHelper","eoModelRegistry","eoBlockWatcher","eoImageCropCoord","eoTemplateImageService",function(b,c,d,e,f,g,h,i,j){return{templateUrl:"ProfileImageUploader.tmpl.html",scope:{onCancel:"&",onSuccess:"&",onError:"&",onProgress:"&",onSaveImage:"&",returnOriginalImage:"@",imageUrl:"=?",uploadUrl:"=?",uploadUnchangedImage:"@",areaType:"@",resultImageAspect:"@"},link:function(b,c,d){b.uploadNewImage=function(){b.dataImg.isFileSelected=!1,b.dataImg.orig=null,a.element(c).find("input").val(null)};var e=c[0].querySelector(".profile_image_outline");e&&j.set("profile_image_outline",e)},controller:["$scope","PROFILE_IMAGE_ACCEPT","PROFILE_IMAGE_AREA_TYPE",function(c,j,k){var l="false"!==c.returnOriginalImage,m="true"===c.uploadUnchangedImage,n=g.get("UploadTypeException");c.imageAccept=j,c.isFileChanged=!1,c.watcher=new h,c.areaType=c.areaType||k,c.dataImg={file:null,orig:"",cropped:"",isFileSelected:!1,isFileChanged:!1},c.$watch("imageUrl",function(a,b){a&&c.watcher.wait(f.loadImageByUrl(a).then(function(b){c.dataImg.file=f.dataURItoBlob(b),c.dataImg.file.name=a.substring(a.lastIndexOf("/")+1),c.dataImg.isFileSelected=!0,c.dataImg.orig=b},function(a){c.onError({result:a})},function(a){c.onProgress({event:a})}))}),c.onFileSelect=function(a,b){var d=a[0];if(d){if(!e.test(d.type))return void c.onError({result:new n({message:"Only images can be selected"})});c.dataImg.file=d,c.dataImg.isFileSelected=!0;var f=new FileReader;f.onload=function(a){c.dataImg.isFileChanged=!0,c.$apply(function(b){b.dataImg.orig=a.target.result})},f.onprogress=function(a){c.onProgress({event:a})},f.readAsDataURL(d)}},c.getFileSelectionStatus=function(){return c.dataImg.isFileSelected},c.cancel=function(){c.onCancel()},c.uploadImage=function(){var e;c.dataImg.isFileChanged&&(e=f.dataURItoBlob(c.dataImg.cropped,{type:c.dataImg.file.type}),e.name=c.dataImg.file.name),c.onSaveImage(),b.upload({url:c.uploadUrl?c.uploadUrl:d,file:c.dataImg.isFileChanged||m?l?c.dataImg.file:e:null,data:{cropCoord:a.toJson(i.get())}}).then(function(a){c.dataImg.isFileChanged=!1,c.onSuccess({result:a})},function(a){c.onError({result:a})},function(a){c.onProgress({event:a})})}}]}}])}(angular),function(){angular.module("components.uploading.uploaders",["components.uploading.uploaders.file","components.uploading.uploaders.profileImage"])}();